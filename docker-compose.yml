dev: &BASE
  build: .
  ports:
    - "4000:4000"
  links:
    - mongo:mongo.dev
  environment:
    - MIX_ENV=dev
    - MONGODB_HOST=mongo.dev
    - MONGODB_PORT=27017
    - MONGODB_DATABASE=shorty_dev
  dns:
    - 8.8.8.8
    - 8.8.4.4
  command: bash -c "mix phoenix.server 1>&1"

prod:
  <<: *BASE
  ports:
    - "5000:5000"
  links:
    - mongo:mongo.prod
  environment:
    - MIX_ENV=prod
    - MONGODB_HOST=mongo.prod
    - MONGODB_DATABASE=shorty_prod
  # Fix for  https://github.com/edevil/docker-erlang-bug#explanation
  # See also https://github.com/elixir-lang/elixir/issues/3342
  command: bash -c "mix compile && mix phoenix.server 1>&1"

tests:
  <<: *BASE
  links:
    - mongo:mongo.test
  environment:
    - MIX_ENV=test
    - MONGODB_HOST=mongo.test
    - MONGODB_DATABASE=shorty_test
  # Fix for  https://github.com/edevil/docker-erlang-bug#explanation
  # See also https://github.com/elixir-lang/elixir/issues/3342
  command: bash -c "mix test 1>&1"

mongo:
  image: mongo:3.4
  command: --smallfiles
